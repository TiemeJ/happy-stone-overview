<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Stones Dashboard</title>
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .stones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stone-card {
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }

        .stone-card:hover {
            transform: translateY(-2px);
            background: #f8f9fa;
        }

        .stone-card.active {
            border: 2px solid #84fab0;
            background: #f0fff4;
        }

        .stone-card h3 {
            margin: 0;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .stone-card p {
            margin: 5px 0 0;
            font-size: 0.8em;
            color: #666;
        }

        #journeyMap {
            height: 400px;
            width: 100%;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .journey-details {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .journey-entry {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #84fab0;
        }

        .recent-updates {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            max-height: 800px;
            overflow-y: auto;
        }

        .update-entry {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #8fd3f4;
            align-items: start;
        }

        .update-content {
            flex: 1;
        }

        .update-entry h3 {
            margin: 0 0 5px 0;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .update-entry p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .update-entry .timestamp {
            font-size: 0.8em;
            color: #666;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            margin: 0;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            font-size: 1.2em;
            color: #84fab0;
            font-weight: bold;
        }

        .journey-photo {
            max-width: 200px;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .journey-photo:hover {
            transform: scale(1.05);
        }

        .update-photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .update-photo:hover {
            transform: scale(1.05);
        }

        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .close-modal {
            position: absolute;
            top: -40px;
            right: -40px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 10px;
            transition: transform 0.2s;
        }

        .close-modal:hover {
            transform: scale(1.1);
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* Admin upload section */
        .admin-upload-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .admin-upload-section h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-input-container input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            display: block;
            padding: 8px 16px;
            cursor: pointer;
            background: #f1f3f5;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.9em;
            transition: all 0.2s;
            text-align: center;
            margin-bottom: 10px;
        }

        .custom-file-upload:hover {
            background: #e9ecef;
        }

        .upload-btn {
            background: #84fab0;
            color: #2c3e50;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .upload-btn:hover {
            background: #5ae296;
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .file-name {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .stone-feature-image {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px auto;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: block;
            border: 4px solid white;
        }

        .stone-feature-image:hover {
            transform: scale(1.05);
        }

        .feature-photo-container {
            background: #f0fff4 !important;
            border-left: 4px solid #84fab0 !important;
            text-align: center;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            .journey-photo, .stone-feature-image {
                max-width: 100%;
            }

            .update-entry {
                grid-template-columns: 1fr;
            }

            .update-photo {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🪨 Happy Stones Dashboard</h1>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator">
            Loading...
        </div>

        <!-- Photo Modal -->
        <div id="photoModal" class="photo-modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closePhotoModal()">×</button>
                <img id="modalImage" src="" alt="Stone location">
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Stones</h3>
                <p id="totalStones">0</p>
            </div>
            <div class="stat-card">
                <h3>Total Journeys</h3>
                <p id="totalJourneys">0</p>
            </div>
            <div class="stat-card">
                <h3>Active This Month</h3>
                <p id="activeStones">0</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="recent-updates">
                <h2>Recent Updates</h2>
                <div id="recentUpdates"></div>
            </div>

            <div class="main-content">
                <div class="stones-grid" id="stonesGrid"></div>
                <div id="journeyMap"></div>
                <div class="journey-details" id="journeyDetails"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase first
        const firebaseConfig = {
            apiKey: "AIzaSyBVMOTMubOV8Y1iEpK-E0TqZC5MptS6jpk",
            authDomain: "happy-stone-tracker.firebaseapp.com",
            projectId: "happy-stone-tracker",
            storageBucket: "happy-stone-tracker.firebasestorage.app",
            messagingSenderId: "454968587977",
            appId: "1:454968587977:web:cce4e67177cdf8029ebf18",
            measurementId: "G-CV38E0V9E4"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        
        // Initialize Firestore and Storage after app initialization
        const db = firebase.firestore();
        const storage = firebase.storage();
        let currentMap = null;
        let activeStoneId = null;
        let selectedFile = null;

        // Loading indicator functions
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        async function getCoordinates(locationString) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationString)}`);
                const data = await response.json();
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error("Error geocoding location:", error);
                return null;
            }
        }

        function openPhotoModal(url) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex';
            modalImg.src = url;
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.style.display = 'none';
        }

        // File input handling
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            document.getElementById('fileName').textContent = selectedFile ? selectedFile.name : '';
            document.getElementById('uploadBtn').disabled = !selectedFile;
        }

        // Upload stone photo
        async function uploadStonePhoto() {
            if (!selectedFile || !activeStoneId) return;
            
            showLoading();
            try {
                console.log(`Uploading photo for stone #${activeStoneId}`);
                
                // Create a reference to the file in Firebase Storage
                // Use simple naming with just the stoneID
                const storageRef = storage.ref(`stones/${activeStoneId}/${activeStoneId}`);
                
                // Upload the file
                const uploadTask = storageRef.put(selectedFile);
                
                // Listen for upload completion
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Progress handling if needed
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    }, 
                    (error) => {
                        // Error handling
                        console.error("Error uploading file:", error);
                        hideLoading();
                        alert("Error uploading file: " + error.message);
                    }, 
                    async () => {
                        try {
                            // Upload completed successfully
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log("File uploaded successfully. URL:", downloadURL);
                            
                            try {
                                // Store the reference in Firestore
                                await db.collection('stones').doc(activeStoneId).update({
                                    featurePhoto: {
                                        url: downloadURL,
                                        filename: selectedFile.name,
                                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }
                                });
                                console.log("Firestore updated with new photo URL");
                            } catch (firestoreError) {
                                console.error("Firestore update error:", firestoreError);
                                // Continue even if Firestore update fails - we still have the image URL
                            }
                            
                            // Reset the file input
                            document.getElementById('fileInput').value = '';
                            document.getElementById('fileName').textContent = '';
                            document.getElementById('uploadBtn').disabled = true;
                            selectedFile = null;
                            
                            // Display the photo directly instead of reloading
                            const journeyDetails = document.getElementById('journeyDetails');
                            
                            // Find the feature photo container in the new layout
                            let featurePhotoContainer = journeyDetails.querySelector('.feature-photo-container');
                            
                            // Update the feature photo content
                            if (featurePhotoContainer) {
                                featurePhotoContainer.innerHTML = `
                                    <h3 style="font-size: 0.9em; margin-top: 0;">Feature Photo</h3>
                                    <img src="${downloadURL}" 
                                        alt="Stone #${activeStoneId}" 
                                        class="stone-feature-image"
                                        onclick="openPhotoModal('${downloadURL}')"
                                    >
                                    <p style="margin-top: 5px; color: #666; font-size: 0.7em;">
                                        Just now
                                    </p>
                                `;
                            }
                            
                            hideLoading();
                            alert("Photo uploaded successfully!");
                            
                            // Scroll to the feature photo section
                            setTimeout(() => {
                                if (featurePhotoContainer) {
                                    featurePhotoContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100);
                        } catch (error) {
                            console.error("Error processing upload completion:", error);
                            hideLoading();
                            alert("Photo uploaded successfully, but there was an issue displaying it. Please refresh the page.");
                        }
                    }
                );
            } catch (error) {
                console.error("Error in upload process:", error);
                hideLoading();
                alert("Error in upload process: " + error.message);
            }
        }

        // Load recent updates across all stones
        async function loadRecentUpdates() {
            const recentUpdates = document.getElementById('recentUpdates');
            recentUpdates.innerHTML = '';
            showLoading();

            try {
                const stonesSnapshot = await db.collection('stones').get();
                let allUpdates = [];

                for (const stoneDoc of stonesSnapshot.docs) {
                    const journeysSnapshot = await stoneDoc.ref.collection('journeys')
                        .orderBy('timestamp', 'desc')
                        .limit(5)
                        .get();

                    journeysSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        allUpdates.push({
                            stoneId: stoneDoc.id,
                            ...data
                        });
                    });
                }

                allUpdates.sort((a, b) => b.timestamp - a.timestamp);

                allUpdates.slice(0, 20).forEach(update => {
                    const date = update.timestamp ? update.timestamp.toDate().toLocaleDateString() : 'Recent';
                    const time = update.timestamp ? update.timestamp.toDate().toLocaleTimeString() : '';
                    
                    const entry = document.createElement('div');
                    entry.className = 'update-entry';
                    
                    let photoHtml = '';
                    if (update.photoData && update.photoData.url) {
                        photoHtml = `
                            <img src="${update.photoData.url}" 
                                alt="Stone photo" 
                                class="update-photo"
                                onclick="openPhotoModal('${update.photoData.url}')"
                                loading="lazy"
                            >
                        `;
                    }

                    entry.innerHTML = `
                        <div class="update-content">
                            <h3>#${update.stoneId}</h3>
                            <p>${update.message}</p>
                            <p class="timestamp">${date} ${time}</p>
                        </div>
                        ${photoHtml}
                    `;
                    recentUpdates.appendChild(entry);
                });

            } catch (error) {
                console.error("Error loading recent updates:", error);
            } finally {
                hideLoading();
            }
        }

        // Modified: Load stone card with feature photo if available but return the card instead of appending it
        async function loadStoneCard(doc) {
            try {
                const journeysSnapshot = await doc.ref.collection('journeys')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const journeyCount = journeysSnapshot.size;
                
                // Get stone data to check for feature photo
                const stoneData = doc.data() || {};
                
                // Create stone card
                const card = document.createElement('div');
                card.className = 'stone-card';
                card.dataset.stoneId = doc.id;
                
                // Check if this stone has a feature photo
                let hasPhoto = stoneData.featurePhoto && stoneData.featurePhoto.url;
                
                // If no photo in Firestore, check Storage directly
                if (!hasPhoto) {
                    try {
                        const storageRef = storage.ref(`stones/${doc.id}/${doc.id}`);
                        await storageRef.getDownloadURL();
                        hasPhoto = true;
                    } catch (err) {
                        // No photo in Storage either
                        hasPhoto = false;
                    }
                }
                
                // Add photo indicator if there's a photo
                card.innerHTML = `
                    <h3>#${doc.id}</h3>
                    ${hasPhoto ? '<div style="color: #84fab0; margin-top: 2px;">📷</div>' : ''}
                    <p>${journeyCount} journeys</p>
                `;
                
                card.onclick = () => selectStone(doc.id);
                
                // Return card and journeyCount instead of appending directly
                return { card, journeyCount };
            } catch (error) {
                console.error(`Error loading stone card ${doc.id}:`, error);
                return { card: null, journeyCount: 0 };
            }
        }

        // Modified: Load all stones with proper ordering
        async function loadStones() {
            showLoading();
            try {
                const snapshot = await db.collection('stones').get();
                const stonesGrid = document.getElementById('stonesGrid');
                stonesGrid.innerHTML = '';
                
                let totalJourneys = 0;
                let activeThisMonth = 0;
                const currentMonth = new Date().getMonth();
                
                // Sort the stones by ID (numerically) before creating cards
                const sortedDocs = [...snapshot.docs].sort((a, b) => {
                    // Convert IDs to numbers for proper numeric sorting
                    // If IDs are not numeric, this falls back to string comparison
                    const idA = parseInt(a.id);
                    const idB = parseInt(b.id);
                    
                    if (!isNaN(idA) && !isNaN(idB)) {
                        return idA - idB; // Numeric sorting
                    } else {
                        return a.id.localeCompare(b.id); // String sorting as fallback
                    }
                });
                
                // Create an array of promises for loading each stone card
                const loadPromises = sortedDocs.map(doc => loadStoneCard(doc));
                
                // Wait for all stone cards to be loaded
                const results = await Promise.all(loadPromises);
                
                // Add cards to the grid in the correct order (same as sortedDocs)
                for (let i = 0; i < results.length; i++) {
                    const { card, journeyCount } = results[i];
                    if (card) {
                        stonesGrid.appendChild(card);
                        totalJourneys += journeyCount;
                    }
                }
                
                // Check which stones are active this month
                for (let i = 0; i < sortedDocs.length; i++) {
                    const doc = sortedDocs[i];
                    const lastJourneySnapshot = await doc.ref.collection('journeys')
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                        
                    if (!lastJourneySnapshot.empty) {
                        const data = lastJourneySnapshot.docs[0].data();
                        if (data.timestamp && data.timestamp.toDate().getMonth() === currentMonth) {
                            activeThisMonth++;
                        }
                    }
                }

                document.getElementById('totalStones').textContent = snapshot.size;
                document.getElementById('totalJourneys').textContent = totalJourneys;
                document.getElementById('activeStones').textContent = activeThisMonth;

            } catch (error) {
                console.error("Error loading stones:", error);
            } finally {
                hideLoading();
            }
        }

        function initMap() {
            if (currentMap) {
                currentMap.remove();
            }

            currentMap = L.map('journeyMap').setView([0, 0], 2);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(currentMap);

            // Add a scale control to the map
            L.control.scale().addTo(currentMap);
        }

        async function selectStone(stoneId) {
            showLoading();
            activeStoneId = stoneId;
            
            console.log(`Selecting stone #${stoneId}`);
            
            document.querySelectorAll('.stone-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.stoneId === stoneId) {
                    card.classList.add('active');
                }
            });

            initMap();

            try {
                // Fetch stone document to get feature photo
                const stoneDoc = await db.collection('stones').doc(stoneId).get();
                const stoneData = stoneDoc.data() || {};
                
                // Clear journey details and set title
                const journeyDetails = document.getElementById('journeyDetails');
                journeyDetails.innerHTML = `<h2>Stone #${stoneId} Journey History</h2>`;
                
                // Create a flex container for admin section and feature photo
                const flexContainer = document.createElement('div');
                flexContainer.style.display = 'flex';
                flexContainer.style.gap = '20px';
                flexContainer.style.marginBottom = '20px';
                flexContainer.style.justifyContent = 'center';
                journeyDetails.appendChild(flexContainer);
                
                // Add admin upload section
                const uploadSection = document.createElement('div');
                uploadSection.className = 'admin-upload-section';
                uploadSection.style.flex = '0 0 170px'; // Match the photo container width
                uploadSection.style.minHeight = '220px';
                uploadSection.style.padding = '10px';
                uploadSection.style.display = 'flex';
                uploadSection.style.flexDirection = 'column';
                uploadSection.innerHTML = `
                    <h3 style="font-size: 0.9em; margin-top: 0;">Upload Stone Photo</h3>
                    <div class="file-input-container" style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                        <label for="fileInput" class="custom-file-upload">
                            Choose File
                        </label>
                        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
                        <div id="fileName" class="file-name"></div>
                        <button id="uploadBtn" class="upload-btn" onclick="uploadStonePhoto()" disabled>Upload</button>
                    </div>
                `;
                flexContainer.appendChild(uploadSection);
                
                // Try to get photo URL - first from Firestore, then from Storage
                let photoUrl = null;
                let uploadDate = 'Recently';
                
                // Check if the stone has a feature photo in Firestore
                if (stoneData.featurePhoto && stoneData.featurePhoto.url) {
                    photoUrl = stoneData.featurePhoto.url;
                    if (stoneData.featurePhoto.uploadedAt) {
                        const date = stoneData.featurePhoto.uploadedAt.toDate();
                        uploadDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    }
                } else {
                    // If not in Firestore, try to get directly from Storage
                    try {
                        console.log("Checking Storage for photo: ", `stones/${stoneId}/${stoneId}`);
                        const storageRef = storage.ref(`stones/${stoneId}/${stoneId}`);
                        photoUrl = await storageRef.getDownloadURL();
                        console.log("Found photo directly in Storage:", photoUrl);
                        
                        // Update Firestore with the photo URL for future reference
                        try {
                            await db.collection('stones').doc(stoneId).update({
                                featurePhoto: {
                                    url: photoUrl,
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }
                            });
                            console.log("Updated Firestore with Storage photo URL");
                        } catch (updateError) {
                            console.error("Error updating Firestore with photo URL:", updateError);
                        }
                    } catch (storageError) {
                        console.log("No feature photo found in Storage:", storageError);
                    }
                }
                
                // Create feature photo container (displayed or empty)
                const featurePhotoContainer = document.createElement('div');
                featurePhotoContainer.className = 'admin-upload-section feature-photo-container';
                featurePhotoContainer.style.flex = '0 0 170px'; // Fixed width for the thumbnail container
                featurePhotoContainer.style.minHeight = '220px';
                featurePhotoContainer.style.textAlign = 'center';
                featurePhotoContainer.style.display = 'flex';
                featurePhotoContainer.style.flexDirection = 'column';
                featurePhotoContainer.style.justifyContent = 'center';
                featurePhotoContainer.style.padding = '10px';
                
                // Display feature photo if it exists
                if (photoUrl) {
                    console.log("Displaying photo:", photoUrl);
                    featurePhotoContainer.innerHTML = `
                        <h3 style="font-size: 0.9em; margin-top: 0;">Stone Photo</h3>
                        <img src="${photoUrl}" 
                            alt="Stone #${stoneId}" 
                            class="stone-feature-image"
                            onclick="openPhotoModal('${photoUrl}')"
                        >
                        <p style="margin-top: 5px; color: #666; font-size: 0.7em;">
                            ${uploadDate}
                        </p>
                    `;
                } else {
                                            featurePhotoContainer.innerHTML = `
                        <h3 style="font-size: 0.9em; margin-top: 0;">Feature Photo</h3>
                        <div style="width: 150px; height: 150px; margin: 5px auto; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 8px; border: 1px dashed #ccc;">
                            <p style="color: #666; margin: 0; font-size: 0.8em;">No photo yet</p>
                        </div>
                    `;
                    console.log("No photo found for this stone");
                }
                
                // Add the feature photo container to the flex container
                flexContainer.appendChild(featurePhotoContainer);

                const journeysSnapshot = await db.collection('stones')
                    .doc(stoneId)
                    .collection('journeys')
                    .orderBy('timestamp', 'desc')
                    .get();

                const coordinates = [];
                const markers = [];
                const bounds = L.latLngBounds();

                const orderedDocs = [...journeysSnapshot.docs].reverse();
                
                for (const doc of orderedDocs) {
                    const data = doc.data();
                    
                    let coords = data.coordinates;
                    if (!coords && data.location) {
                        coords = await getCoordinates(data.location);
                    }

                    if (coords) {
                        coordinates.push([coords.lat, coords.lon]);
                        bounds.extend([coords.lat, coords.lon]);
                        
                        let popupContent = `
                            <div style="max-width: 200px;">
                                <b>${data.location}</b>
                                <p style="margin: 5px 0;">${data.message}</p>
                        `;
                        
                        if (data.photoData && data.photoData.url) {
                            popupContent += `
                                <img src="${data.photoData.url}" 
                                    style="width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer;"
                                    onclick="openPhotoModal('${data.photoData.url}')"
                                >
                            `;
                        }
                        
                        popupContent += '</div>';
                        
                        const marker = L.marker([coords.lat, coords.lon])
                            .addTo(currentMap)
                            .bindPopup(popupContent);
                        markers.push(marker);
                    }
                }

                if (coordinates.length > 0) {
                    const path = L.polyline(coordinates, {
                        color: '#3498db',
                        weight: 3,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round',
                        dashArray: '5, 10'
                    }).addTo(currentMap);

                    currentMap.fitBounds(bounds, { padding: [50, 50] });
                }

                journeysSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : 'Recent';
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : '';
                    
                    let photoHtml = '';
                    if (data.photoData && data.photoData.url) {
                        photoHtml = `
                            <img src="${data.photoData.url}" 
                                alt="Stone location" 
                                class="journey-photo"
                                onclick="openPhotoModal('${data.photoData.url}')"
                                loading="lazy"
                            >
                        `;
                    }

                    const entry = document.createElement('div');
                    entry.className = 'journey-entry';
                    entry.innerHTML = `
                        <h3>📍 ${data.location}</h3>
                        ${photoHtml}
                        <p>${data.message}</p>
                        <p style="color: #666; font-size: 0.9em;">${date} ${time}</p>
                    `;
                    journeyDetails.appendChild(entry);
                });

            } catch (error) {
                console.error("Error loading stone journeys:", error);
            } finally {
                hideLoading();
            }
        }

        // Initialize the dashboard
        window.onload = () => {
            loadStones();
            loadRecentUpdates();
            initMap();

            // Event listeners for modal
            document.getElementById('photoModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePhotoModal();
                }
            });

            // Handle escape key for modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePhotoModal();
                }
            });

            // Handle window resize for map
            window.addEventListener('resize', function() {
                if (currentMap) {
                    currentMap.invalidateSize();
                }
            });
        };
    </script>
</body>
</html>
